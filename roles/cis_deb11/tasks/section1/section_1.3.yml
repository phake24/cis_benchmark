- name: | 
    "1.3 Filesystem Integrity Checking"
    "1.3.1 Ensure AIDE is installed (Automated)"
  become: yes
  block:
    - name: "1.3.1 |-> Installing aide"
      apt:
        name: ["aide", "aide-common"]
        state: present
        update_cache: yes
      when: ansible_os_family == "Debian"
      register: result
    - name: "1.3.1 |-> Installing aide"
      dnf:
          name: aide
          state: present
          update_cache: yes
      when: ansible_os_family == "RedHat"
      register: result
    - name: "1.3.1 |-> Initializing AIDE"
      command: /usr/sbin/aideinit
      when: 
        - result.changed
        - ansible_os_family == "Debian"
    - name: "1.3.1 |-> Initializing AIDE"
      command: aide --init
      when:
        - result.changed
        - ansible_os_family == "RedHat"
    - name: "1.3.1 |-> Creating AIDE Database"
      command: mv /var/lib/aide/aide.db.new /var/lib/aide/aide.db
      when: 
        - result.changed
        - ansible_os_family == "Debian"
    - name: "1.3.1 |-> Creating AIDE Database"
      command: mv /var/lib/aide/aide.db.new.gz /var/lib/aide/aide.db.gz
      when: 
        - result.changed
        - ansible_os_family == "RedHat"
  when: 
    - level1|bool
  tags:
    - section 1
    - section 1.3
    - section 1.3.1

- name: "1.3.2 Ensure filesystem integrity is regularly checked (Automated)"
  become: yes
  vars: 
    aidecheck_service_file: /etc/systemd/system/aidecheck.service
    aidecheck_timer_file: /etc/systemd/system/aidecheck.timer
  block:
    - copy:
        dest: "{{ aidecheck_service_file }}"
        content: |
          # {{ aidecheck_service_file }}
          #
          # {{ hardening_header }}
          [Unit]
          Description=Aide Check
          [Service]
          Type=simple
          ExecStart=/usr/bin/aide --config /etc/aide/aide.conf --check
          [Install]
          WantedBy=multi-user.target
        mode: 0644
        owner: root
        group: root
      notify: reload systemd
    - copy:
        dest: "{{ aidecheck_timer_file }}"
        content: |
          # {{ aidecheck_timer_file }}
          #
          # {{ hardening_header }}
          [Unit]
          Description=Aide check every day at 5AM
          [Timer]
          OnCalendar=*-*-* 05:00:00
          Unit=aidecheck.service
          [Install]
          WantedBy=multi-user.target
        mode: 0644
        owner: root
        group: root
      notify: reload systemd
    - systemd:
        name: aidecheck.service
        state: started
        enabled: yes
    - systemd:
        name: aidecheck.timer
        state: started
        enabled: yes
  when: level1|bool
  tags:
    - section 1
    - section 1.3
    - section 1.3.2
